<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Zotero Connector</title>
  <style>
    :root {
      --bg: #F2F2F7;
      /* 背景灰 */
      --surface: #FFFFFF;
      /* 表面白 */
      --text: #1C1C1E;
      /* 深黑 */
      --sub: #8E8E93;
      /* 次级灰 */
      --accent: #007AFF;
      /* 交互蓝 */
      --accent-bg: #EBF5FF;
      /* 浅蓝 */
      --border: #E5E5EA;
      /* 分割线 */
      --green: #34C759;
      /* 成功/PDF */
    }

    /* 全局禁止选择，仅允许输入框 */
    * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    input, textarea {
      -webkit-user-select: text;
      user-select: text;
      -webkit-touch-callout: default;
    }

    /* 1. 全屏重置 - iOS system grouped background */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background-color: #F2F2F7;
      color: var(--text);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* 2. 顶部固定区域 */
    header {
      background: var(--surface);
      padding: 12px 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
      flex-shrink: 0;
      /* 防止被压缩 */
      z-index: 10;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h1::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
      display: inline-block;
    }

    /* 配置折叠面板 */
    details {
      font-size: 13px;
      color: var(--sub);
      position: relative; /* Anchor for floating panel */
    }

    summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      text-align: right;
    }

    summary:hover {
      color: var(--accent);
    }

    /* Floating Config Panel */
    .config-panel {
      position: absolute;
      top: 100%;
      right: 0;
      width: 260px;
      margin-top: 8px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* 输入控件 */
    input,
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border: none;
      background: #EFEFF4; /* iOS input gray */
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      color: #000;
      box-shadow: none;
    }

    input:focus {
      background: #fff;
      box-shadow: 0 0 0 2px var(--accent);
    }
    select:focus {
      background: #EFEFF4;
      box-shadow: none;
    }

    /* Local/Cloud mode toggle (Redesigned: iOS Segmented Control) */
    .mode-options {
      display: flex;
      background-color: #7676801f;
      padding: 2px;
      border-radius: 8px;
      margin-bottom: 4px; /* Space before inputs */
    }

    .mode-option {
      flex: 1;
      padding: 6px 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid transparent;
      background: transparent;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
      -webkit-user-select: none;
      white-space: nowrap; /* Prevent text wrapping */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mode-option:first-child,
    .mode-option:last-child {
      border-radius: 6px;
      border: 1px solid transparent;
    }

    .mode-option.active {
      background: #FFFFFF;
      color: #000;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 0.5px 1px rgba(0, 0, 0, 0.04);
      border: 0.5px solid rgba(0, 0, 0, 0.04);
    }

    .mode-option:not(.active):hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* 搜索栏 */
    .search-bar {
      position: relative;
      display: flex;
      gap: 8px;
    }

    #q {
      background: #EFEFF4;
      /* iOS Search Bar Color */
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      box-shadow: none;
    }

    #q:focus {
      background: #fff;
      border: 1px solid var(--accent);
    }

    #btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 0 16px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
    }

    #btn:active {
      opacity: 0.7;
    }

    /* 筛选行 */
    .filter-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .filter-row select {
      flex: 1;
      min-width: 0;
    }
    #filter-tag.reorder-done {
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    #filter-tag.reorder-flash {
      background-color: var(--accent-bg);
      box-shadow: 0 0 0 1px var(--accent);
    }

    /* 3. 滚动内容区域 */
    #content-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      /* iOS顺滑滚动 */
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* 状态提示 */
    #log {
      font-size: 13px;
      color: var(--sub);
      text-align: center;
      padding: 10px 0;
    }

    /* 文献列表容器：整体圆角 */
    .list-container {
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    /* 每一条：横向 flex，左侧内容 + 右侧 + 按钮 */
    .list-item {
      padding: 14px 16px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item:active {
      background: #fafafa;
    }

    .list-item-body {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .add-to-mn-btn {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent-bg);
      color: var(--accent);
      font-size: 20px;
      font-weight: 300;
      line-height: 1;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .add-to-mn-btn:hover {
      opacity: 0.9;
    }

    .add-to-mn-btn:active {
      opacity: 0.7;
    }

    .list-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text);
    }

    .meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--sub);
      flex-wrap: wrap;
    }

    .tag {
      background: #F0F0F5;
      color: #666;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    /* 按钮组 */
    .action-row {
      margin-top: 4px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 100px;
      /* 胶囊圆角 */
      font-size: 12px;
      font-weight: 500;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .pill:hover {
      opacity: 0.8;
    }

    .pill-zotero {
      background: var(--accent-bg);
      color: var(--accent);
    }

    .pill-web {
      background: #F2F2F7;
      color: #666;
    }

    .pill-pdf {
      background: #E8F5E9;
      color: #2E7D32;
    }

    /* Green */

    /* View switcher: Library | Selected Cards */
    .view-switcher {
      display: flex;
      align-items: center;
      background-color: #7676801f;
      padding: 2px;
      border-radius: 8px;
      margin-top: 12px;
    }
    .selected-reload-icon {
      color: var(--sub);
      font-size: 18px;
      line-height: 12px;
      margin-left: 4px;
      user-select: none;
      -webkit-user-select: none;
    }
    .view-option {
      flex: 1;
      padding: 6px 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid transparent;
      background: transparent;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
      -webkit-user-select: none;
    }
    .view-option.active {
      background: #FFFFFF;
      color: #000;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 0.5px 1px rgba(0, 0, 0, 0.04);
      border: 0.5px solid rgba(0, 0, 0, 0.04);
    }
    .view-option:not(.active):hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* Library view: search + filters + content */
    /* Library view: iOS-style white surface, outer margin around form */
    #library-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      background-color: var(--surface);
      padding: 16px;
      margin: 0;
    }
    #library-view .search-bar { margin-bottom: 0; }
    #library-view .filter-row { flex-shrink: 0; }
    #library-view #content-area {
      flex: 1;
      min-height: 0;
      padding-left: 0;
      padding-right: 0;
      padding-bottom: 16px;
    }

    /* Selected Cards panel */
    #selected-panel {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
      gap: 12px;
      min-height: 0;
    }
    #selected-panel.show {
      display: flex;
    }
    .selected-empty-state {
      font-size: 13px;
      color: var(--sub);
      text-align: center;
      padding: 24px 16px;
    }
    .selected-toolbar {
      display: flex;
      gap: 8px;
      padding: 4px 0 12px 0;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .selected-toolbar button {
      padding: 0 16px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
      height: 36px;
      line-height: 36px;
    }
    .selected-toolbar button:active { opacity: 0.7; }
    #btn-select-in-zotero {
      background: var(--accent);
      color: white;
    }
    #btn-copy-reference {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    #btn-copy-reference:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

  <header>
    <div class="top-row">
      <h1>Zotero Connector</h1>
      <details id="settings-details">
        <summary>Settings</summary>
        <div class="config-panel">
          <input type="hidden" id="mode" value="L">
          <div class="mode-options">
            <span class="mode-option active" data-value="L" role="button">Local API</span>
            <span class="mode-option" data-value="C" role="button">Cloud API</span>
          </div>
          <input id="uid" placeholder="UserID" style="display:none">
          <input id="slug" placeholder="Username" style="display:none">
          <input id="key" type="password" placeholder="API Key" style="display:none">
        </div>
      </details>
    </div>

    <div class="view-switcher">
      <span class="view-option active" data-view="library" role="button">Library</span>
      <span class="view-option" data-view="selected" role="button">Selected Cards<span id="selected-reload-icon" class="selected-reload-icon" style="display: none;"> ⟳</span></span>
    </div>
  </header>

  <div id="library-view">
    <div class="search-bar">
      <input id="q" placeholder="Keywords (Title, Author, Year)..." onkeydown="event.key=='Enter'&&run()">
      <button id="btn" onclick="run()">Search</button>
    </div>
    <div class="filter-row">
      <select id="filter-collection">
        <option value="">All</option>
      </select>
      <select id="filter-tag" multiple size="4">
      </select>
    </div>
    <div id="content-area">
      <div id="log">Ready to search.</div>
      <div id="out"></div>
    </div>
  </div>

  <div id="selected-panel">
    <div id="selected-toolbar" class="selected-toolbar" style="display: none;">
      <button type="button" id="btn-select-in-zotero">Select in Zotero</button>
      <button type="button" id="btn-copy-reference" disabled>Copy Reference</button>
    </div>
    <div id="selected-empty" class="selected-empty-state">Loading…</div>
    <div id="selected-list" class="list-container" style="display: none;"></div>
  </div>

  <script>
    const $ = i => document.getElementById(i);
    const API = { L: 'http://localhost:23119/api/users', C: 'https://api.zotero.org/users' };

    function resetFilterOptions() {
      var colSelect = $('filter-collection');
      var tagSelect = $('filter-tag');
      if (colSelect) { colSelect.innerHTML = '<option value="">All</option>'; }
      if (tagSelect) { tagSelect.innerHTML = ''; }
    }

    async function loadFilters() {
      var mode = $('mode').value;
      var uid = ($('uid') && $('uid').value) || '';
      var key = ($('key') && $('key').value) || '';
      if (mode === 'L') uid = '0';
      if (mode === 'C' && !uid) return;
      var headers = { 'Zotero-API-Version': 3 };
      if (mode === 'C' && key) headers['Zotero-API-Key'] = key;
      var base = API[mode] + '/' + uid;
      var doFetch = mode === 'L' ? localFetch : function (url, opts) { return fetch(url, opts); };
      var colSelect = $('filter-collection');
      var tagSelect = $('filter-tag');
      if (!colSelect || !tagSelect) return;
      colSelect.innerHTML = '<option value="">All</option>';
      tagSelect.innerHTML = '';
      try {
        var colRes = await doFetch(base + '/collections', { headers: headers });
        if (colRes.ok) {
          var colls = await colRes.json();
          if (Array.isArray(colls)) {
            for (var c = 0; c < colls.length; c++) {
              var ckey = colls[c].key;
              var cname = (colls[c].data && colls[c].data.name) ? colls[c].data.name : (ckey || '');
              var opt = document.createElement('option');
              opt.value = ckey || '';
              opt.textContent = cname;
              colSelect.appendChild(opt);
            }
          }
        }
      } catch (e) { }
      try {
        var tagRes = await doFetch(base + '/tags', { headers: headers });
        if (tagRes.ok) {
          var tags = await tagRes.json();
          if (Array.isArray(tags)) {
            for (var t = 0; t < tags.length; t++) {
              var tagName = tags[t].tag != null ? String(tags[t].tag) : '';
              if (!tagName) continue;
              var topt = document.createElement('option');
              topt.value = encodeURIComponent(tagName);
              topt.textContent = tagName;
              tagSelect.appendChild(topt);
            }
          }
        }
      } catch (e) { }
    }
    window.__onPanelShow = function () { loadFilters(); };

    function showLibraryView() {
      $('library-view').style.display = 'flex';
      $('selected-panel').classList.remove('show');
      var icon = $('selected-reload-icon');
      if (icon) icon.style.display = 'none';
      var opts = document.querySelectorAll('.view-option[data-view]');
      opts.forEach(function (o) {
        o.classList.toggle('active', o.getAttribute('data-view') === 'library');
      });
    }
    function showSelectedCardsView() {
      $('library-view').style.display = 'none';
      $('selected-panel').classList.add('show');
      var icon = $('selected-reload-icon');
      if (icon) icon.style.display = 'inline';
      var opts = document.querySelectorAll('.view-option[data-view]');
      opts.forEach(function (o) {
        o.classList.toggle('active', o.getAttribute('data-view') === 'selected');
      });
      $('selected-empty').style.display = 'block';
      $('selected-empty').textContent = 'Loading…';
      $('selected-list').style.display = 'none';
      $('selected-list').innerHTML = '';
      var iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = 'mnzotero://getSelectedNotes';
      document.body.appendChild(iframe);
      setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 500);
    }
    function switchView(view) {
      if (view === 'library') showLibraryView();
      else if (view === 'selected') showSelectedCardsView();
    }
    window.onSelectedNotes = function () {
      var list = window.__selectedNotes;
      if (!Array.isArray(list)) list = [];
      var toolbarEl = $('selected-toolbar');
      var emptyEl = $('selected-empty');
      var listEl = $('selected-list');
      if (list.length === 0) {
        if (toolbarEl) toolbarEl.style.display = 'none';
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'No literature cards in current selection.';
        listEl.style.display = 'none';
        listEl.innerHTML = '';
        return;
      }
      if (toolbarEl) toolbarEl.style.display = 'flex';
      emptyEl.style.display = 'none';
      listEl.style.display = 'block';
      var html = list.map(function (item) {
        var title = (item.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        return '<div class="list-item"><div class="list-item-body"><div class="list-title">' + title + '</div></div></div>';
      }).join('');
      listEl.innerHTML = html;
    };
    (function initSelectedToolbar() {
      var btnSelect = $('btn-select-in-zotero');
      if (btnSelect) {
        btnSelect.addEventListener('click', function () {
          var list = window.__selectedNotes;
          if (!Array.isArray(list) || list.length === 0) return;
          var keys = list.map(function (item) { return item.itemKey || ''; }).filter(Boolean);
          if (keys.length === 0) return;
          var url = 'zotero://select/library/items?itemKey=' + keys.join(',');
          var a = document.createElement('a');
          a.href = url;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
      }
    })();
    (function initViewSwitcher() {
      document.querySelectorAll('.view-option[data-view]').forEach(function (el) {
        el.addEventListener('click', function () {
          var view = this.getAttribute('data-view');
          if (view) switchView(view);
        });
      });
    })();

    function upd() {
      const isC = $('mode').value === 'C';
      $('key').style.display = isC ? 'block' : 'none';
      $('uid').style.display = isC ? 'block' : 'none';
      $('slug').style.display = isC ? 'block' : 'none';
      resetFilterOptions();
      loadFilters();
    }

    (function initModeOptions() {
      var opts = document.querySelectorAll('.mode-option');
      var modeInput = $('mode');
      
      function setConfig(key, val) {
        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = 'mnzotero://setConfig?key=' + encodeURIComponent(key) + '&val=' + encodeURIComponent(val);
        document.body.appendChild(iframe);
        setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 500);
      }

      function loadConfig(config) {
        if (!config) return;
        ['uid', 'slug', 'key', 'mode'].forEach(id => {
          if (config[id] !== undefined) {
            $(id).value = config[id];
            if (id === 'mode') {
              opts.forEach(function (o) {
                if (o.getAttribute('data-value') === config[id]) o.classList.add('active');
                else o.classList.remove('active');
              });
            }
          }
        });
        upd();
      }

      // Initial load from injected config if present
      if (window.__mnConfig) {
        loadConfig(window.__mnConfig);
      }

      // Listener for late injection
      window.onMNConfig = function() {
        loadConfig(window.__mnConfig);
      };

      // Save changes automatically via protocol
      ['uid', 'slug', 'key'].forEach(id => {
        $(id).addEventListener('input', function() {
          setConfig(id, this.value);
          resetFilterOptions();
          loadFilters();
        });
      });

      opts.forEach(function (el) {
        el.addEventListener('click', function () {
          var v = this.getAttribute('data-value');
          modeInput.value = v;
          setConfig('mode', v);
          opts.forEach(function (o) { o.classList.remove('active'); });
          this.classList.add('active');
          upd();
        });
      });

      var colSelect = $('filter-collection');
      var tagSelect = $('filter-tag');
      if (colSelect) colSelect.addEventListener('change', function () { this.blur(); });
      if (tagSelect) {
        tagSelect.addEventListener('change', function () {
          var sel = this;
          var selected = Array.from(sel.selectedOptions || []);
          if (selected.length === 0) return;
          for (var i = selected.length - 1; i >= 0; i--) sel.insertBefore(selected[i], sel.firstChild);
          sel.classList.add('reorder-done', 'reorder-flash');
          setTimeout(function () {
            sel.classList.remove('reorder-flash');
          }, 200);
        });
      }
    })();

    function localFetch(url, options) {
      return new Promise(function (resolve, reject) {
        var id = 'req_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        window.__mnFetchCb = window.__mnFetchCb || {};
        window.__mnFetchCb[id] = function (err, data) {
          try { delete window.__mnFetchCb[id]; } catch (e) { }
          if (err) reject(new Error(err));
          else resolve({
            ok: data && data.ok,
            status: data && data.status,
            json: function () { return Promise.resolve(data && data.body != null ? data.body : {}); }
          });
        };
        window.__mnFetchPending = JSON.stringify({ id: id, url: url, options: options || {} });
        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = 'mnzotero://fetch';
        document.body.appendChild(iframe);
        setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 500);
      });
    }

    function buildCreateNoteUrl(title, type, year, author, linkZotero, linkPdf, linkWeb, linkCloudPdf, itemKey, mode, uid, apiKey) {
      var q = [
        'title=' + encodeURIComponent(title),
        'type=' + encodeURIComponent(type || ''),
        'year=' + encodeURIComponent(year || ''),
        'author=' + encodeURIComponent(author || ''),
        'lZ=' + encodeURIComponent(linkZotero || ''),
        'itemKey=' + encodeURIComponent(itemKey || ''),
        'mode=' + encodeURIComponent(mode || ''),
        'uid=' + encodeURIComponent(uid || ''),
        'key=' + encodeURIComponent(apiKey || '')
      ];
      if (linkPdf) q.push('lP=' + encodeURIComponent(linkPdf));
      if (linkWeb) q.push('lW=' + encodeURIComponent(linkWeb));
      if (linkCloudPdf) q.push('lC=' + encodeURIComponent(linkCloudPdf));
      return 'mnzotero://createNote?' + q.join('&');
    }

    async function run() {
      const q = $('q').value.trim();
      // Allow empty search to list all items
      // if (!q) return; 

      let [mode, uid, slug, key] = ['mode', 'uid', 'slug', 'key'].map(i => $(i).value);
      // Local mode always uses '0' as userID internally
      if (mode === 'L') uid = '0';
      
      const ui = { btn: $('btn'), log: $('log'), out: $('out') };

      ui.btn.disabled = true;
      ui.out.innerHTML = '';
      ui.log.style.display = 'block';
      ui.log.innerText = 'Searching...';

      var headers = { 'Zotero-API-Version': 3 };
      if (mode === 'C' && key) headers['Zotero-API-Key'] = key;
      const base = `${API[mode]}/${uid}`;
      const doFetch = mode === 'L' ? localFetch : function (url, opts) { return fetch(url, opts); };

      var colSelect = $('filter-collection');
      var tagSelect = $('filter-tag');
      var collectionKey = (colSelect && colSelect.value ? colSelect.value : '').trim();
      var selectedTags = tagSelect && tagSelect.selectedOptions ? Array.from(tagSelect.selectedOptions).map(function (o) { return o.value; }) : [];
      var path = collectionKey ? base + '/collections/' + collectionKey + '/items' : base + '/items';
      var params = ['limit=100'];
      if (q) params.push('q=' + encodeURIComponent(q));
      for (var ti = 0; ti < selectedTags.length; ti++) { params.push('tag=' + selectedTags[ti]); }
      var queryString = params.length ? ('?' + params.join('&')) : '';
      var url = path + queryString;

      try {
        var r1 = await doFetch(url, { headers: headers });
        if (!r1.ok) throw new Error("Connection Failed");

        // 2. Filter
        // Removed .slice(0, 15) to show all fetched items
        const items = (await r1.json()).filter(i => !['attachment', 'note'].includes(i.data.itemType));

        if (!items.length) { ui.log.innerText = 'No matches found.'; return; }
        ui.log.innerText = `Fetching attachments for ${items.length} items...`;

        // 3. Enrichment: Local = serial (one __mnFetchPending at a time), Cloud = parallel
        var cards;
        if (mode === 'L') {
          cards = [];
          for (var i = 0; i < items.length; i++) {
            var d = items[i].data;
            var pdf = null;
            try {
              var r2 = await doFetch(base + '/items/' + d.key + '/children', { headers: headers });
              if (r2.ok) {
                var kids = await r2.json();
                var p = kids.find(function (k) { return k.data.itemType === 'attachment' && (k.data.contentType === 'application/pdf' || (k.data.filename || '').endsWith('.pdf')); });
                if (p) pdf = p.data.key;
              }
            } catch (e) { }
            var lItem = 'zotero://select/library/items/' + d.key;
            var btns = '<a href="' + lItem + '" class="pill pill-zotero">Zotero Item</a>';
            if (pdf) {
              var lPdf = 'zotero://open-pdf/library/items/' + pdf;
              btns += '<a href="' + lPdf + '" class="pill pill-pdf">Local PDF</a>';
            }
            var addTitle = (d.title || 'Untitled').replace(/"/g, '&quot;');
            var year = (d.date || '').substring(0, 4) || '';
            var author = (d.creators && d.creators[0] && d.creators[0].lastName) || 'Unknown';
            var createNoteUrl = buildCreateNoteUrl(d.title || 'Untitled', d.itemType, year, author, lItem, pdf ? ('zotero://open-pdf/library/items/' + pdf) : '', '', '', d.key, mode, uid, key);
            cards.push('<div class="list-item"><div class="list-item-body"><div class="list-title">' + addTitle + '</div><div class="meta-row"><span class="tag">' + d.itemType + '</span><span>' + author + '</span><span>' + (d.date || '') + '</span></div><div class="action-row">' + btns + '</div></div><a href="' + createNoteUrl + '" class="add-to-mn-btn" title="Add to MN">+</a></div>');
          }
        } else {
          cards = await Promise.all(items.map(async function (item) {
            var d = item.data;
            var pdf = null;
            try {
              var r2 = await doFetch(base + '/items/' + d.key + '/children', { headers: headers });
              if (r2.ok) {
                var kids = await r2.json();
                var p = kids.find(function (k) { return k.data.itemType === 'attachment' && (k.data.contentType === 'application/pdf' || (k.data.filename || '').endsWith('.pdf')); });
                if (p) pdf = p.data.key;
              }
            } catch (e) { }
            var u = slug || 'user';
            var lItem = 'zotero://select/library/items/' + d.key;
            var cItem = 'https://www.zotero.org/' + u + '/items/' + d.key;
            var btns = '<a href="' + lItem + '" class="pill pill-zotero">Zotero Item</a><a href="' + cItem + '" target="_blank" class="pill pill-web">Web</a>';
            if (pdf) {
              var lPdf = 'zotero://open-pdf/library/items/' + pdf;
              var cPdf = 'https://www.zotero.org/' + u + '/items/' + d.key + '/attachment/' + pdf + '/reader';
              btns += '<a href="' + lPdf + '" class="pill pill-pdf">Local PDF</a><a href="' + cPdf + '" target="_blank" class="pill pill-web">Cloud PDF</a>';
            }
            var addTitle = (d.title || 'Untitled').replace(/"/g, '&quot;');
            var year = (d.date || '').substring(0, 4) || '';
            var author = (d.creators && d.creators[0] && d.creators[0].lastName) || 'Unknown';
            var createNoteUrl = buildCreateNoteUrl(d.title || 'Untitled', d.itemType, year, author, lItem, pdf ? lPdf : '', cItem, pdf ? cPdf : '', d.key, mode, uid, key);
            return '<div class="list-item"><div class="list-item-body"><div class="list-title">' + addTitle + '</div><div class="meta-row"><span class="tag">' + d.itemType + '</span><span>' + author + '</span><span>' + (d.date || '') + '</span></div><div class="action-row">' + btns + '</div></div><a href="' + createNoteUrl + '" class="add-to-mn-btn" title="Add to MN">+</a></div>';
          }));
        }

        ui.out.innerHTML = '<div class="list-container">' + cards.join('') + '</div>';
        ui.log.style.display = 'none'; // Hide log on success

      } catch (e) { ui.log.innerText = 'Error: ' + e.message; }
      finally { ui.btn.disabled = false; }
    }
  </script>
</body>

</html>