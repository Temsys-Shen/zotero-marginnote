<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zotero Min</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;background:#121212;color:#ddd;max-width:680px;margin:2rem auto;padding:0 1rem}
input,select,button{background:#1e1e1e;border:1px solid #333;color:inherit;padding:.6rem;border-radius:4px;font-size:.9rem;outline:none}
button{background:#228be6;color:#fff;border:none;cursor:pointer;font-weight:600}
button:disabled{opacity:.5}
.row{display:flex;gap:.5rem;margin-bottom:.5rem}
.grow{flex:1}
details{border:1px solid #333;padding:.5rem;margin-bottom:1rem;background:#1e1e1e;border-radius:4px}
summary{cursor:pointer;color:#888;font-size:.8rem}
.item{border-bottom:1px solid #333;padding:.8rem 0}
.meta{font-size:.8rem;color:#888;margin:.3rem 0}
a{color:#4dabf7;text-decoration:none;margin-right:.8rem;font-size:.85rem}
a:hover{text-decoration:underline}
.pdf{color:#69db7c}
</style>
</head>
<body>

<details>
    <summary>Settings</summary>
    <div class="row" style="margin-top:.5rem">
        <select id="mode"><option value="L">Local</option><option value="C">Cloud</option></select>
        <input id="uid" class="grow" placeholder="UserID (0 for Local)" value="0">
    </div>
    <div class="row">
        <input id="slug" class="grow" placeholder="Username (slug)">
        <input id="key" class="grow" type="password" placeholder="API Key" style="display:none">
    </div>
</details>

<div class="row">
    <input id="q" class="grow" placeholder="Search...">
    <button id="btn">Find</button>
</div>
<div id="log" style="color:#888;font-size:.8rem;font-style:italic;min-height:1.2em"></div>
<div id="out"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const $ = function(i) { return document.getElementById(i); };
  const API = { L: 'http://localhost:23119/api/users', C: 'https://api.zotero.org/users' };

  function upd() {
    var isC = $('mode').value === 'C';
    $('key').style.display = isC ? 'block' : 'none';
    $('uid').value = isC ? '' : '0';
  }

  async function run() {
    var q = $('q').value.trim();
    if (!q) return;

    var mode = $('mode').value, uid = $('uid').value, slug = $('slug').value, key = $('key').value;
    var ui = { btn: $('btn'), log: $('log'), out: $('out') };

    ui.btn.disabled = true;
    ui.out.innerHTML = '';
    ui.log.innerText = 'Searching...';

    try {
      var headers = { 'Zotero-API-Version': 3 };
      if (mode === 'C' && key) headers['Zotero-API-Key'] = key;
      var base = API[mode] + '/' + uid;

      var r1 = await fetch(base + '/items?q=' + encodeURIComponent(q) + '&limit=25', { headers: headers });
      if (!r1.ok) throw new Error(r1.status);

      var data = await r1.json();
      var items = data.filter(function(i) { return ['attachment','note'].indexOf(i.data.itemType) === -1; }).slice(0, 15);

      if (!items.length) { ui.log.innerText = 'No matches.'; return; }
      ui.log.innerText = 'Found ' + items.length + '. Fetching PDFs...';

      var rows = await Promise.all(items.map(function(item) {
        var d = item.data;
        return (async function() {
          var pdf = null;
          try {
            var r2 = await fetch(base + '/items/' + d.key + '/children', { headers: headers });
            if (r2.ok) {
              var kids = await r2.json();
              for (var i = 0; i < kids.length; i++) {
                var k = kids[i];
                if (k.data.itemType === 'attachment' && k.data.contentType === 'application/pdf') {
                  pdf = k.data.key;
                  break;
                }
              }
            }
          } catch (e) {}

          var uUser = slug || 'user';
          var lnkL = 'zotero://select/library/items/' + d.key;
          var lnkC = 'https://www.zotero.org/' + uUser + '/items/' + d.key;
          var links = '<a href="' + lnkL + '">Local</a><a href="' + lnkC + '" target="_blank">Web</a>';
          if (pdf) {
            links += '<span style="color:#444">|</span><a href="zotero://open-pdf/library/items/' + pdf + '" class="pdf">PDF</a>';
            links += '<a href="https://www.zotero.org/' + uUser + '/items/' + d.key + '/attachment/' + pdf + '/reader" target="_blank" class="pdf">Cloud Reader</a>';
          }

          var title = d.title || 'Untitled';
          var meta = d.itemType + ' · ' + (d.date || '') + ' · ' + (d.creators && d.creators[0] && d.creators[0].lastName ? d.creators[0].lastName : '');
          return '<div class="item"><div style="font-weight:600">' + title + '</div><div class="meta">' + meta + '</div><div style="margin-top:.4rem">' + links + '</div></div>';
        })();
      }));

      ui.out.innerHTML = rows.join('');
      ui.log.innerText = 'Done (' + items.length + ').';
    } catch (e) { ui.log.innerText = 'Error: ' + e.message; }
    finally { ui.btn.disabled = false; }
  }

  $('mode').onchange = upd;
  $('q').onkeydown = function(e) { if (e.key === 'Enter') run(); };
  $('btn').onclick = run;
  upd();
});
</script>
</body>
</html>
