<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Zotero Connector - Library</title>
    <link rel="stylesheet" href="common.css">
</head>

<body>

    <header>
        <div class="top-row">
            <h1>Zotero Connector</h1>
            <details id="settings-details">
                <summary>Settings</summary>
                <div class="config-panel">
                    <input type="hidden" id="mode" value="L">
                    <div class="mode-options">
                        <span class="mode-option active" data-value="L" role="button">Local API</span>
                        <span class="mode-option" data-value="C" role="button">Cloud API</span>
                    </div>
                    <input id="uid" placeholder="UserID" style="display:none">
                    <input id="slug" placeholder="Username" style="display:none">
                    <div class="password-container">
                        <input id="key" type="password" placeholder="API Key" style="display:none">
                        <span class="toggle-password" onclick="togglePasswordVisibility()" style="display:none"></span>
                    </div>
                </div>
            </details>
        </div>

        <div class="view-switcher">
            <span class="view-option active" data-view="library" role="button">Library</span>
            <span class="view-option" data-view="selected" role="button">Selected Cards</span>
        </div>
    </header>

    <div id="library-view">
        <div class="search-bar">
            <input id="q" placeholder="Keywords (Title, Author, Year)..." onkeydown="event.key=='Enter'&&run()">
            <button id="btn" onclick="run()">Search</button>
        </div>
        <div class="filter-row">
            <select id="filter-collection">
                <option value="">All</option>
            </select>
            <select id="filter-tag" multiple size="4">
            </select>
        </div>
        <div id="content-area">
            <div id="log">Ready to search.</div>
            <div id="out"></div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        function resetFilterOptions() {
            var colSelect = $('filter-collection');
            var tagSelect = $('filter-tag');
            if (colSelect) { colSelect.innerHTML = '<option value="">All</option>'; }
            if (tagSelect) { tagSelect.innerHTML = ''; }
        }

        async function loadFilters() {
            var mode = $('mode').value;
            var uid = ($('uid') && $('uid').value) || '';
            var key = ($('key') && $('key').value) || '';
            if (mode === 'L') uid = '0';
            if (mode === 'C' && !uid) return;
            var headers = { 'Zotero-API-Version': 3 };
            if (mode === 'C' && key) headers['Zotero-API-Key'] = key;
            var base = API[mode] + '/' + uid;
            var doFetch = mode === 'L' ? localFetch : function (url, opts) { return fetch(url, opts); };
            var colSelect = $('filter-collection');
            var tagSelect = $('filter-tag');
            if (!colSelect || !tagSelect) return;
            colSelect.innerHTML = '<option value="">All</option>';
            tagSelect.innerHTML = '';
            try {
                var colRes = await doFetch(base + '/collections', { headers: headers });
                if (colRes.ok) {
                    var colls = await colRes.json();
                    if (Array.isArray(colls)) {
                        for (var c = 0; c < colls.length; c++) {
                            var ckey = colls[c].key;
                            var cname = (colls[c].data && colls[c].data.name) ? colls[c].data.name : (ckey || '');
                            var opt = document.createElement('option');
                            opt.value = ckey || '';
                            opt.textContent = cname;
                            colSelect.appendChild(opt);
                        }
                    }
                }
            } catch (e) { }
            try {
                var tagRes = await doFetch(base + '/tags', { headers: headers });
                if (tagRes.ok) {
                    var tags = await tagRes.json();
                    if (Array.isArray(tags)) {
                        for (var t = 0; t < tags.length; t++) {
                            var tagName = tags[t].tag != null ? String(tags[t].tag) : '';
                            if (!tagName) continue;
                            var topt = document.createElement('option');
                            topt.value = encodeURIComponent(tagName);
                            topt.textContent = tagName;
                            tagSelect.appendChild(topt);
                        }
                    }
                }
            } catch (e) { }
        }

        // Panel show hook for library
        window.__onPanelShow = function () { loadFilters(); };

        // Initial config load for filters (if common.js loaded early)
        var colSelect = $('filter-collection');
        var tagSelect = $('filter-tag');
        if (colSelect) colSelect.addEventListener('change', function () { this.blur(); });
        if (tagSelect) {
            tagSelect.addEventListener('change', function () {
                var sel = this;
                var selected = Array.from(sel.selectedOptions || []);
                if (selected.length === 0) return;
                for (var i = selected.length - 1; i >= 0; i--) sel.insertBefore(selected[i], sel.firstChild);
                sel.classList.add('reorder-done', 'reorder-flash');
                setTimeout(function () {
                    sel.classList.remove('reorder-flash');
                }, 200);
            });
        }

        function buildCreateNoteUrl(title, type, year, author, linkZotero, linkPdf, linkWeb, linkCloudPdf, itemKey, mode, uid, apiKey) {
            var q = [
                'title=' + encodeURIComponent(title),
                'type=' + encodeURIComponent(type || ''),
                'year=' + encodeURIComponent(year || ''),
                'author=' + encodeURIComponent(author || ''),
                'lZ=' + encodeURIComponent(linkZotero || ''),
                'itemKey=' + encodeURIComponent(itemKey || ''),
                'mode=' + encodeURIComponent(mode || ''),
                'uid=' + encodeURIComponent(uid || ''),
                'key=' + encodeURIComponent(apiKey || '')
            ];
            if (linkPdf) q.push('lP=' + encodeURIComponent(linkPdf));
            if (linkWeb) q.push('lW=' + encodeURIComponent(linkWeb));
            if (linkCloudPdf) q.push('lC=' + encodeURIComponent(linkCloudPdf));
            return 'mnzotero://createNote?' + q.join('&');
        }

        function buildDownloadPdfUrl(uid, attachmentKey, title, apiKey, requestId) {
            var q = [
                'uid=' + encodeURIComponent(uid || ''),
                'attachmentKey=' + encodeURIComponent(attachmentKey || ''),
                'fileName=' + encodeURIComponent(title || 'Untitled'),
                'requestId=' + encodeURIComponent(requestId || '')
            ];
            if (apiKey) q.push('key=' + encodeURIComponent(apiKey));
            return 'mnzotero://downloadPdf?' + q.join('&');
        }

        function buildDownloadPdfIcon() {
            return '<svg class="pdf-download-icon" viewBox="0 0 100 100" aria-hidden="true"><g class="pdf-rotor"><rect width="100" height="100" rx="8" fill="#E53935"></rect><text x="50%" y="52%" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle" dominant-baseline="middle">PDF</text><circle class="pdf-plus-badge" cx="80" cy="80" r="12" fill="white"></circle><path class="pdf-plus-mark" d="M75 80 H85 M80 75 V85" stroke="#E53935" stroke-width="3" stroke-linecap="round"></path></g></svg>';
        }

        var __mnDownloadPending = {};
        var __mnSeq = 0;

        function createMNRequestId() {
            __mnSeq += 1;
            return 'mn_dl_' + Date.now() + '_' + __mnSeq;
        }

        function sendMNProtocol(url) {
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 600);
        }

        function startDownloadButtonMotion(btn) {
            var rotor = btn.querySelector('.pdf-rotor');
            if (!rotor) return null;
            var plusMark = btn.querySelector('.pdf-plus-mark');
            btn.classList.remove('is-finishing', 'is-success', 'is-failed');
            btn.classList.add('is-downloading');
            if (plusMark) plusMark.style.opacity = '0';
            rotor.style.animation = 'none';
            rotor.offsetHeight;
            rotor.style.animation = 'mn-download-spin 0.9s linear infinite';
            return { rotor: rotor };
        }

        function finishDownloadButtonMotion(btn, state, ok) {
            if (!btn) return;
            btn.classList.add('is-finishing');
            if (ok) btn.classList.add('is-success');
            else btn.classList.add('is-failed');
            setTimeout(function () {
                var rotor = state && state.rotor ? state.rotor : btn.querySelector('.pdf-rotor');
                var plusMark = btn.querySelector('.pdf-plus-mark');
                if (rotor) {
                    rotor.style.animation = 'none';
                    rotor.style.transform = 'rotate(0deg)';
                }
                if (plusMark) plusMark.style.opacity = '';
                btn.classList.remove('is-downloading', 'is-finishing', 'is-success', 'is-failed');
            }, 350);
        }

        function findDownloadButton(node) {
            var current = node;
            while (current && current !== document) {
                if (current.classList && current.classList.contains('download-pdf-btn')) return current;
                current = current.parentNode;
            }
            return null;
        }

        window.onMNDownloadResult = function (requestId, ok, errorMsg) {
            var entry = __mnDownloadPending[requestId];
            if (!entry) return;
            delete __mnDownloadPending[requestId];
            finishDownloadButtonMotion(entry.button, entry.motion, !!ok);
        };

        document.addEventListener('click', function (event) {
            var btn = findDownloadButton(event.target);
            if (!btn) return;
            event.preventDefault();
            if (btn.classList.contains('is-downloading')) return;

            var uid = btn.getAttribute('data-uid') || '';
            var attachmentKey = btn.getAttribute('data-attachment-key') || '';
            var fileName = btn.getAttribute('data-file-name') || 'Untitled';
            var apiKey = btn.getAttribute('data-api-key') || '';
            if (!uid || !attachmentKey) return;

            var requestId = createMNRequestId();
            var motion = startDownloadButtonMotion(btn);
            __mnDownloadPending[requestId] = { button: btn, motion: motion };
            setTimeout(function () {
                var stale = __mnDownloadPending[requestId];
                if (!stale) return;
                delete __mnDownloadPending[requestId];
                finishDownloadButtonMotion(stale.button, stale.motion, false);
            }, 45000);
            var protocolUrl = buildDownloadPdfUrl(uid, attachmentKey, fileName, apiKey, requestId);
            sendMNProtocol(protocolUrl);
        }, false);

        async function run() {
            const q = $('q').value.trim();
            let [mode, uid, slug, key] = ['mode', 'uid', 'slug', 'key'].map(i => $(i).value);
            if (mode === 'L') uid = '0';

            const ui = { btn: $('btn'), log: $('log'), out: $('out') };

            ui.btn.disabled = true;
            ui.out.innerHTML = '';
            ui.log.style.display = 'block';
            ui.log.innerText = 'Searching...';

            var headers = { 'Zotero-API-Version': 3 };
            if (mode === 'C' && key) headers['Zotero-API-Key'] = key;
            const base = `${API[mode]}/${uid}`;
            const doFetch = mode === 'L' ? localFetch : function (url, opts) { return fetch(url, opts); };

            var colSelect = $('filter-collection');
            var tagSelect = $('filter-tag');
            var collectionKey = (colSelect && colSelect.value ? colSelect.value : '').trim();
            var selectedTags = tagSelect && tagSelect.selectedOptions ? Array.from(tagSelect.selectedOptions).map(function (o) { return o.value; }) : [];
            var path = collectionKey ? base + '/collections/' + collectionKey + '/items' : base + '/items';
            var params = ['limit=100'];
            if (q) params.push('q=' + encodeURIComponent(q));
            for (var ti = 0; ti < selectedTags.length; ti++) { params.push('tag=' + selectedTags[ti]); }
            var queryString = params.length ? ('?' + params.join('&')) : '';
            var url = path + queryString;

            try {
                var r1 = await doFetch(url, { headers: headers });
                if (!r1.ok) throw new Error("Connection Failed");

                const items = (await r1.json()).filter(i => !['attachment', 'note'].includes(i.data.itemType));

                if (!items.length) { ui.log.innerText = 'No matches found.'; return; }
                ui.log.innerText = `Fetching attachments for ${items.length} items...`;

                var cards;
                if (mode === 'L') {
                    cards = [];
                    for (var i = 0; i < items.length; i++) {
                        var d = items[i].data;
                        var pdf = null;
                        try {
                            var r2 = await doFetch(base + '/items/' + d.key + '/children', { headers: headers });
                            if (r2.ok) {
                                var kids = await r2.json();
                                var p = kids.find(function (k) { return k.data.itemType === 'attachment' && (k.data.contentType === 'application/pdf' || (k.data.filename || '').endsWith('.pdf')); });
                                if (p) pdf = p.data.key;
                            }
                        } catch (e) { }
                        var lItem = 'zotero://select/library/items/' + d.key;
                        var btns = '<a href="' + lItem + '" class="pill pill-zotero">Zotero Item</a>';
                        if (pdf) {
                            var lPdf = 'zotero://open-pdf/library/items/' + pdf;
                            btns += '<a href="' + lPdf + '" class="pill pill-pdf">Local PDF</a>';
                        }
                        var addTitle = (d.title || 'Untitled').replace(/"/g, '&quot;');
                        var year = (d.date || '').substring(0, 4) || '';
                        var author = (d.creators && d.creators[0] && (d.creators[0].lastName || d.creators[0].name)) || 'Unknown';
                        var createNoteUrl = buildCreateNoteUrl(d.title || 'Untitled', d.itemType, year, author, lItem, pdf ? ('zotero://open-pdf/library/items/' + pdf) : '', '', '', d.key, mode, uid, key);
                        cards.push('<div class="list-item"><div class="list-item-body"><div class="list-title">' + addTitle + '</div><div class="meta-row"><span class="tag">' + d.itemType + '</span><span>' + author + '</span><span>' + (d.date || '') + '</span></div><div class="action-row">' + btns + '</div></div><a href="' + createNoteUrl + '" class="add-to-mn-btn" title="Add to MN">+</a></div>');
                    }
                } else {
                    cards = await Promise.all(items.map(async function (item) {
                        var d = item.data;
                        var pdf = null;
                        try {
                            var r2 = await doFetch(base + '/items/' + d.key + '/children', { headers: headers });
                            if (r2.ok) {
                                var kids = await r2.json();
                                var p = kids.find(function (k) { return k.data.itemType === 'attachment' && (k.data.contentType === 'application/pdf' || (k.data.filename || '').endsWith('.pdf')); });
                                if (p) pdf = p.data.key;
                            }
                        } catch (e) { }
                        var u = slug || 'user';
                        var lItem = 'zotero://select/library/items/' + d.key;
                        var cItem = 'https://www.zotero.org/' + u + '/items/' + d.key;
                        var btns = '<a href="' + lItem + '" class="pill pill-zotero">Zotero Item</a><a href="' + cItem + '" target="_blank" class="pill pill-web">Web</a>';
                        if (pdf) {
                            var lPdf = 'zotero://open-pdf/library/items/' + pdf;
                            var cPdf = 'https://www.zotero.org/' + u + '/items/' + d.key + '/attachment/' + pdf + '/reader';
                            btns += '<a href="' + lPdf + '" class="pill pill-pdf">Local PDF</a><a href="' + cPdf + '" target="_blank" class="pill pill-web">Cloud PDF</a>';
                        }
                        var addTitle = (d.title || 'Untitled').replace(/"/g, '&quot;');
                        var year = (d.date || '').substring(0, 4) || '';
                        var author = (d.creators && d.creators[0] && (d.creators[0].lastName || d.creators[0].name)) || 'Unknown';
                        var createNoteUrl = buildCreateNoteUrl(d.title || 'Untitled', d.itemType, year, author, lItem, pdf ? lPdf : '', cItem, pdf ? cPdf : '', d.key, mode, uid, key);
                        var actionButtons = '';
                        if (pdf) {
                            var safeTitle = (d.title || 'Untitled').replace(/"/g, '&quot;');
                            var safeKey = String(key || '').replace(/"/g, '&quot;');
                            actionButtons += '<a href="#" class="add-to-mn-btn download-pdf-btn" title="Download PDF" data-uid="' + uid + '" data-attachment-key="' + pdf + '" data-file-name="' + safeTitle + '" data-api-key="' + safeKey + '">' + buildDownloadPdfIcon() + '</a>';
                        }
                        actionButtons += '<a href="' + createNoteUrl + '" class="add-to-mn-btn" title="Add to MN">+</a>';
                        return '<div class="list-item"><div class="list-item-body"><div class="list-title">' + addTitle + '</div><div class="meta-row"><span class="tag">' + d.itemType + '</span><span>' + author + '</span><span>' + (d.date || '') + '</span></div><div class="action-row">' + btns + '</div></div><div class="list-item-actions">' + actionButtons + '</div></div>';
                    }));
                }

                ui.out.innerHTML = '<div class="list-container">' + cards.join('') + '</div>';
                ui.log.style.display = 'none';

            } catch (e) { ui.log.innerText = 'Error: ' + e.message; }
            finally { ui.btn.disabled = false; }
        }
    </script>
</body>

</html>
