<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Zotero Connector - Selection</title>
    <link rel="stylesheet" href="common.css">
    <script src="i18n.js"></script>
    <script>
        // 初始化 HTML 静态文本
        document.addEventListener('DOMContentLoaded', function() {
            // Header
            document.querySelector('h1').textContent = T('app_title');
            document.querySelector('#settings-details > summary').textContent = T('settings');
            
            // Settings
            var modeOptions = document.querySelectorAll('.mode-option');
            modeOptions.forEach(function(opt, idx) {
                var values = [T('local_api'), T('cloud_api')];
                if (idx < values.length) opt.textContent = values[idx];
            });
            
            document.getElementById('uid').placeholder = T('user_id');
            document.getElementById('slug').placeholder = T('username');
            document.getElementById('key').placeholder = T('api_key');
            
            // View switcher
            var viewOptions = document.querySelectorAll('.view-option');
            viewOptions.forEach(function(opt, idx) {
                var values = [T('library'), T('selected_cards')];
                if (idx < values.length) opt.textContent = values[idx];
            });
            
            // Toolbar buttons
            var btnSelect = document.getElementById('btn-select-in-zotero');
            var btnExportAll = document.getElementById('btn-export-all-notes');
            if (btnSelect) btnSelect.textContent = T('select_in_zotero');
            if (btnExportAll) btnExportAll.textContent = T('push_all_notes');
            
            // Empty state
            var emptyEl = document.getElementById('selected-empty');
            if (emptyEl) emptyEl.textContent = T('loading');
        });
    </script>
</head>

<body>

    <header>
        <div class="top-row">
            <h1>Zotero Connector</h1>
            <details id="settings-details">
                <summary>Settings</summary>
                <div class="config-panel">
                    <input type="hidden" id="mode" value="L">
                    <div class="mode-options">
                        <span class="mode-option active" data-value="L" role="button">Local API</span>
                        <span class="mode-option" data-value="C" role="button">Cloud API</span>
                    </div>
                    <input id="uid" placeholder="UserID" style="display:none">
                    <input id="slug" placeholder="Username" style="display:none">
                    <input id="key" type="password" placeholder="API Key" style="display:none">
                </div>
            </details>
        </div>

        <div class="view-switcher">
            <span class="view-option" data-view="library" role="button">Library</span>
            <span class="view-option active" data-view="selected" role="button">Selected Cards<span
                    id="selected-reload-icon" class="selected-reload-icon" style="display: inline;"> ⟳</span></span>
        </div>
    </header>

    <div id="selected-panel" class="show">
        <div id="selected-toolbar" class="selected-toolbar" style="display: none;">
            <button type="button" id="btn-select-in-zotero">Select in Zotero</button>
            <button type="button" id="btn-export-all-notes">Push All Notes</button>
        </div>
        <div id="selected-empty" class="selected-empty-state">Loading…</div>
        <div id="selected-list" class="list-container" style="display: none;"></div>
    </div>

    <script src="common.js"></script>
    <script>
        function loadSelectedNotes() {
            var emptyEl = $('selected-empty');
            if (emptyEl) emptyEl.style.display = 'block';
            if (emptyEl) emptyEl.textContent = T('loading');
            var listEl = $('selected-list');
            if (listEl) listEl.style.display = 'none';
            if (listEl) listEl.innerHTML = '';
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = 'mnzotero://getSelectedNotes';
            document.body.appendChild(iframe);
            setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 500);
        }

        function sendMNProtocol(url) {
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 600);
        }

        function getSyncConfig() {
            var mode = $('mode') ? $('mode').value : '';
            var uid = $('uid') ? String($('uid').value || '').trim() : '';
            var key = $('key') ? String($('key').value || '').trim() : '';
            return { mode: mode, uid: uid, key: key };
        }

        // Auto-load on page load
        loadSelectedNotes();
        // Also bind reload icon if desired
        var reloadIcon = $('selected-reload-icon');
        if (reloadIcon) reloadIcon.onclick = loadSelectedNotes;

        window.onSelectedNotes = function () {
            var list = window.__selectedNotes;
            if (!Array.isArray(list)) list = [];
            var toolbarEl = $('selected-toolbar');
            var emptyEl = $('selected-empty');
            var listEl = $('selected-list');
            if (list.length === 0) {
                if (toolbarEl) toolbarEl.style.display = 'none';
                if (emptyEl) emptyEl.style.display = 'block';
                if (emptyEl) emptyEl.textContent = T('no_literature_cards');
                if (listEl) listEl.style.display = 'none';
                if (listEl) listEl.innerHTML = '';
                return;
            }
            if (toolbarEl) toolbarEl.style.display = 'flex';
            if (emptyEl) emptyEl.style.display = 'none';
            if (listEl) listEl.style.display = 'block';
            var html = list.map(function (item) {
                var title = (item.title || '').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"');
                var noteId = item.noteId || '';
                var itemKey = item.itemKey || '';
                return '<div class="list-item selectable-note-row" onclick="focusNote(\'' + noteId + '\')" style="cursor:pointer;">'
                    + '<div class="list-item-body"><div class="list-title">' + title + '</div></div>'
                    + '<div class="list-item-actions">'
                    + '<button type="button" class="row-export-btn" onclick="exportSingle(event,\'' + noteId + '\',\'' + itemKey + '\')">' + T('push_note') + '</button>'
                    + '</div></div>';
            }).join('');
            if (listEl) listEl.innerHTML = html;
        };

        function focusNote(noteId) {
            if (!noteId) return;
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = 'mnzotero://focusNote?noteId=' + encodeURIComponent(noteId);
            document.body.appendChild(iframe);
            setTimeout(function () { try { iframe.remove(); } catch (e) { } }, 500);
        }

        function exportSingle(evt, noteId, itemKey) {
            if (evt && evt.stopPropagation) evt.stopPropagation();
            var cfg = getSyncConfig();
            var q = [
                'mode=' + encodeURIComponent(cfg.mode || ''),
                'uid=' + encodeURIComponent(cfg.uid || ''),
                'key=' + encodeURIComponent(cfg.key || ''),
                'noteId=' + encodeURIComponent(noteId || ''),
                'itemKey=' + encodeURIComponent(itemKey || '')
            ];
            sendMNProtocol('mnzotero://exportLiteratureNotes?' + q.join('&'));
        }

        (function initSelectedToolbar() {
            var btnSelect = $('btn-select-in-zotero');
            var btnExportAll = $('btn-export-all-notes');
            if (btnSelect) {
                btnSelect.addEventListener('click', function () {
                    var list = window.__selectedNotes;
                    if (!Array.isArray(list) || list.length === 0) return;
                    var keys = list.map(function (item) { return item.itemKey || ''; }).filter(Boolean);
                    if (keys.length === 0) return;
                    var url = 'zotero://select/library/items?itemKey=' + keys.join(',');
                    var a = document.createElement('a');
                    a.href = url;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
                btnSelect.textContent = T('select_in_zotero');
            }
            if (btnExportAll) {
                btnExportAll.addEventListener('click', function () {
                    var cfg = getSyncConfig();
                    var q = [
                        'mode=' + encodeURIComponent(cfg.mode || ''),
                        'uid=' + encodeURIComponent(cfg.uid || ''),
                        'key=' + encodeURIComponent(cfg.key || '')
                    ];
                    sendMNProtocol('mnzotero://exportAllLiteratureNotes?' + q.join('&'));
                });
                btnExportAll.textContent = T('push_all_notes');
            }
        })();
    </script>
</body>

</html>